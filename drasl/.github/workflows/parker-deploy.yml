name: Parker deployment

on:
  push:
    branches:
      - trunk

permissions:
  contents: write

jobs:
  deploy-parker:
    name: Deploy Parker-code to "parker-deploy" branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: main-code
      - name: Checkout "parker-deploy
        uses: actions/checkout@v4
        with:
          path: parker-deploy
          ref: parker-deploy
      - name: Configure git for commits
        run: |
          git config --global user.email "{user.id}+{user.login}@users.noreply.github.com"
          git config --global user.name "parker-deploy GitHub Action"

      - name: Sync Parker code to "parker-deploy"
        run: |
          rsync -av --delete --exclude ".git/*" "main-code/parker/." "parker-deploy/."
      - name: Deploy code
        run: |
          cd "parker-deploy" && \
          git status && \
          date +%s > timestamp.txt && \
          git add -A && \
          git commit -a -m 'Deploying to "parker-deploy" branch' && \
          git push --set-upstream origin parker-deploy && \
          echo -n 'Deployed commit with ID ' && \
          git log -n 1 | grep ^commit -A 0 -B 0 | awk '{print $2}'
